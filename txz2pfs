#!/bin/sh
#For PuppyRus-Zero with Slackware packages
v="190819"

[ ! "$1" ] && echo "Usage $0 *.txz" && exit
d="`basename "$1" .txz`"
#d2="var/lib/pacman/local/`basename "$1" |sed 's/-[^-]*$//'`"
#d2="$(basename "$d" .pkg.tar.xz)"
#d2="var/lib/pacman/local/$(basename "$d2" -any)"
#d2="var/lib/pacman/local/$(basename "$d2" -`uname -m`)"
#d2="var/lib/pacman/local/$(basename "$1" -`uname -m`.pkg.tar.xz |sed -e 's/\-[0-9].*$//g')"
#echo $d $d2;exit
mkdir "$d"
cd "$d"
xz -dc ../"$1" |tar xvf - 

#[ -f install/doinst.sh ] && mv install/doinst.sh start.sh && chmod 755 start.sh && cat install/slack-desc |grep acl: >>start.sh
if [ -f install/slack-desc ]; then 
    mkdir -p etc/packages/mount/$d
    cat install/slack-desc |tail -n 11 > etc/packages/mount/$d/pfs.specs
fi

#создаем нужные сим.ссылки
[ -f install/doinst.sh ] && chmod 755 install/doinst.sh && ./install/doinst.sh

#удаляем unstall
rm -rf install  >/dev/null 2>&1
if [ -d sbin ] && [ -d bin ]; then 
    mv sbin/* bin && rm -d sbin >/dev/null 2>&1
else
    [ -d sbin ] && mkdir bin && mv sbin/* bin && rm -d sbin >/dev/null 2>&1
fi
if [ -d lib ] && [ -d usr/lib ]; then
    mv lib/* usr/lib && rm -d lib  >/dev/null 2>&1
else
    [ -d lib ] && mkdir usr/lib && mv lib/* usr/lib && rm -d lib  >/dev/null 2>&1
fi
if [ -d usr/sbin ] && [ -d usr/bin ]; then
    mv usr/sbin/* usr/bin && rm -d usr/sbin  >/dev/null 2>&1
else
    [ -d usr/sbin ] && mkdir usr/bin && mv usr/sbin/* usr/bin && rm -d usr/sbin  >/dev/null 2>&1
fi

cd ..
./trim -lm "$d"
./trim -d "$d"


#требуется патченый файл pfs чтобы не затирался файл pfs.specs с описанием.
#mkpfs --mklist "$d"
